[Unit]
Description=LLM Router (Hardened Production)
Documentation=file:///opt/llm-router/docs/
After=network.target wg-quick@wg0.service
Wants=wg-quick@wg0.service
PartOf=wg-quick@wg0.service
Requires=network.target

[Service]
Type=exec
User=llm-router
Group=llm-router
WorkingDirectory=/opt/llm-router
Environment=ENVIRONMENT=production
ExecStartPre=/usr/local/bin/check-llm-security.sh
ExecStart=/opt/llm-router/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 443 --ssl-keyfile /etc/llm-router/certs/server.key --ssl-certfile /etc/llm-router/certs/server.crt
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
KillMode=mixed
KillSignal=SIGINT
TimeoutStopSec=30

# Standard output/error
StandardOutput=journal
StandardError=journal
SyslogIdentifier=llm-router

# Process and privilege restrictions
NoNewPrivileges=yes
RemainAfterExit=no

# Filesystem restrictions
PrivateTmp=yes
ProtectHome=read-only
ProtectSystem=strict
ProtectKernelLogs=yes
ProtectKernelModules=yes
ProtectKernelTunables=yes
ProtectControlGroups=yes
ProtectClock=yes
ProtectHostname=yes
PrivateDevices=yes
PrivateMounts=yes

# Writable paths (minimal required paths)
ReadWritePaths=/var/log/llm-router /var/lib/llm-router /run/llm-router /tmp
ReadOnlyPaths=/etc/llm-router /run/inference

# Network restrictions
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6
IPAddressDeny=any
IPAddressAllow=localhost 
IPAddressAllow=10.0.0.0/24  # WireGuard network
IPAddressAllow=127.0.0.0/8  # Localhost

# System call restrictions
SystemCallFilter=@system-service
SystemCallFilter=~@debug @mount @cpu-emulation @obsolete @privileged @reboot @swap @raw-io
SystemCallErrorNumber=EPERM

# Memory and execution restrictions
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes
LockPersonality=yes

# Capabilities (drop all, add only what's needed)
CapabilityBoundingSet=
AmbientCapabilities=
# Note: Binding to port 443 requires CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE

# Namespace restrictions
PrivateUsers=no  # Disabled to allow binding privileged ports
PrivateNetwork=no  # Need network access
PrivateIPC=yes
PrivateUTS=yes

# Resource limits
LimitNOFILE=8192
LimitNPROC=2048
LimitCORE=0
LimitMEMLOCK=64M  # Allow memory locking for HPKE keys
TasksMax=512

# Device access restrictions
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero rw
DeviceAllow=/dev/random r
DeviceAllow=/dev/urandom r
DevicePolicy=closed

# Logging and monitoring
LogLevel=info
LogTarget=journal

# Security and sandboxing
UMask=0077
KeyringMode=private

[Install]
WantedBy=multi-user.target